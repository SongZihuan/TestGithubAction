name: Publish Go Code

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - master

env:
  PACKAGE_NAME: huan-go-test
  PACKAGE_FILE_NAME_DEB: huan-go-test-package-deb
  PACKAGE_FILE_NAME_RPM: huan-go-test-package-rpm
  BINARY_FILE_NAME: huan-go-test
  OUTPUT_UBUNTU_NAME: huan-go-test-ubuntu
  OUTPUT_REHL_NAME: huan-go-test-rehl
  VERSION_FILE: VERSION
  CHANGE_LOG_DEB_BRANCH: changelog-deb

jobs:
  ready:
    # Ê≠§Â§Ñ if ‰∏≠‰∏çËÉΩ‰ΩøÁî®env
    if: github.event_name == 'pull_request' && github.event.pull_request.head.ref != 'changelog-deb' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get default branch
        id: get_branch
        run: |
          if git ls-remote --heads origin main | grep -q main; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "default branch: main"
          elif git ls-remote --heads origin master | grep -q master; then
            echo "branch=master" >> $GITHUB_OUTPUT
            echo "default branch: master"
          else
            echo "default branch not found"
            exit 1
          fi

    outputs:
      branch: ${{ steps.get_branch.outputs.branch }}

  build-ubuntu:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      volumes:
        - /home/runner/work:/home/runner/work
        - /home/runner/work:/__w
    needs: ready

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.4' # Ê†πÊçÆÈúÄË¶ÅÊåáÂÆöGoÁâàÊú¨

      - name: Build go
        run: go build -o "${{ github.workspace }}/${{ env.OUTPUT_UBUNTU_NAME }}" -trimpath -ldflags="-s -w" github.com/SongZihuan/TestGithubAction

      - name: List build directory
        run: |
          ls -l "${{ github.workspace }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_UBUNTU_NAME }}
          path: ${{ github.workspace }}/${{ env.OUTPUT_UBUNTU_NAME }}
          if-no-files-found: error

  build-redhat:
    runs-on: ubuntu-latest
    container:
      image: redhat/ubi9
      volumes:
        - /home/runner/work:/home/runner/work
        - /home/runner/work:/__w
    needs: ready

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.4' # Ê†πÊçÆÈúÄË¶ÅÊåáÂÆöGoÁâàÊú¨

      - name: Build go
        run: go build -o "${{ github.workspace }}/${{ env.OUTPUT_REHL_NAME }}" -trimpath -ldflags="-s -w" github.com/SongZihuan/TestGithubAction

      - name: List build directory
        run: ls -l "${{ github.workspace }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_REHL_NAME }}
          path: ${{ github.workspace }}/${{ env.OUTPUT_REHL_NAME }}
          if-no-files-found: error

  create_release:
    runs-on: ubuntu-latest
    needs:
      - build-ubuntu
      - build-redhat

    permissions: write-all

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
          fetch-tags: true

      - name: Fetch all tags
        run: git fetch --tags

      - name: Create tag
        id: tag_version
        run: |
          if [ -f ${{ github.workspace }}/${{ env.VERSION_FILE }} ]; then
            echo "VERSION file found."
          
            if git tag --list | grep -q "^$(cat ${{ env.VERSION_FILE }})$"; then
              if [[ -n $(git tag --sort=-creatordate | grep -i '^v'  | head -1) ]]; then
                tag=$(git tag --sort=-creatordate | grep -i '^v'  | head -1 | awk -F. '{print $1"."$2+1".0"}')
                echo "tag=$tag" >> $GITHUB_OUTPUT
                echo "version=$(echo $tag | sed 's/^v//')" >> $GITHUB_OUTPUT
                echo "Auto Version is $tag"
              else
                echo "tag=v0.1.0" >> $GITHUB_OUTPUT
                echo "version=0.1.0" >> $GITHUB_OUTPUT
                echo "First Version is v0.1.0"
              fi
            else
              echo "tag=$(cat ${{ env.VERSION_FILE }})" >> $GITHUB_OUTPUT
              echo "version=$(echo $tag | sed 's/^v//')" >> $GITHUB_OUTPUT
              echo "File Version is $(cat ${{ env.VERSION_FILE }})"
            fi
          else
            echo "VERSION file not found."
          
            if [[ -n $(git tag --sort=-creatordate | grep -i '^v'  | head -1) ]]; then
              tag=$(git tag --sort=-creatordate | grep -i '^v'  | head -1 | awk -F. '{print $1"."$2+1".0"}')
              echo "tag=$tag" >> $GITHUB_OUTPUT
              echo "version=$(echo $tag | sed 's/^v//')" >> $GITHUB_OUTPUT
              echo "Auto (Not File) Version is $tag"
            else
                echo "tag=v0.1.0" >> $GITHUB_OUTPUT
                echo "version=0.1.0" >> $GITHUB_OUTPUT
                echo "First Version is v0.1.0"
            fi
          fi

      - name: Create Git tag
        run: git tag "${{ steps.tag_version.outputs.tag }}"

      - name: Download ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.OUTPUT_UBUNTU_NAME }}
          path: ${{ github.workspace }}

      - name: Download redhat artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.OUTPUT_REHL_NAME }}
          path: ${{ github.workspace }}

      - name: List directory
        run: ls -l ${{ github.workspace }}

      - name: Push tag to github
        run: git push origin "${{ steps.tag_version.outputs.tag }}"

      - name: Write gpg public key
        run: |
          echo "${{ secrets.GPG_PUBLIC_KEY }}" > ${{ github.workspace }}/gpg_public_key.asc

      - name: Write gpg key id
        run: |
          echo "${{ secrets.GPG_KEY_ID }}" > ${{ github.workspace }}/${{ secrets.GPG_KEY_ID }}.gpg.key.id

      - name: Make release body
        run: |
          touch ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          
          echo '## Êñ∞ÁâàÊú¨ ${{ steps.tag_version.outputs.tag }} Ê≠£ÂºèÂèëÂ∏É üöÄüöÄüöÄ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo 'Ê¨¢ËøéÂ§ßÂÆ∂ÂâçÊù•‰ΩìÈ™å‰ΩøÁî®ÔºÅ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

            echo '### GPGËØ¥Êòé' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
            echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

              echo '#### Linux‰∏ä' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo '‰Ω†ÂèØ‰ª•ÈÄöËøá `GPG Key ID` ‰∏ãËΩΩ/ÂÆâË£ÖÊàë‰ª¨ÁöÑ `GPG` ËØÅ‰π¶ÔºåÁÑ∂ÂêéÈÄöËøáËØÅ‰π¶È™åËØÅÊàë‰ª¨ÁöÑÊñá‰ª∂ÔºÅ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo 'Êàë‰ª¨ÁöÑ `GPG Key ID: ${{ secrets.GPG_KEY_ID }}` „ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

                echo '##### ‰∏ãËΩΩ GPG ËØÅ‰π¶' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '‰Ω†ÂèØ‰ª•ÈÄöËøáÂëΩ‰ª§ `GPG` ËøõË°åÊìç‰ΩúÔºå‰æãÂ¶ÇÔºö`gpg --keyserver keyserver.ubuntu.com --recv-keys ${{ secrets.GPG_KEY_ID }}`' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo 'ÂÖ∂‰∏≠ `keyserver.ubuntu.com` ÊòØ `GPG` ÂÖ¨ÂºÄÊúçÂä°Âô®Ôºå‰Ω†‰πüÂèØ‰ª•Êç¢Áî®Âà´ÁöÑ„ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

                echo '##### ÂÆâË£Ö GPG ËØÅ‰π¶' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '‰Ω†Âè™ÈúÄË¶Å‰∏ãËΩΩÊàë‰ª¨Êèê‰æõÁöÑ `gpg_public_key.asc` ÁÑ∂ÂêéÊâßË°åÔºå`gpg --import gpg_public_key.asc`' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

                echo '##### È™åËØÅÊñá‰ª∂' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo 'Áî± `GPG` ÁîüÊàêÁöÑÂàÜÁ¶ªÂºèÁ≠æÂêçÁî± `.sig` ÁªìÂ∞æÔºåÂèØ‰ª•ÈÄöËøá `gpg --verify xxx.sig xxx` ËøõË°åÈ™åËØÅÔºåÂÖ∂‰∏≠ `xxx` ‰∏∫ÈúÄË¶ÅÈ™åËØÅÁöÑÊñá‰ª∂„ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo 'Áî± `sha256sum` ËÆ°ÁÆóÁöÑÊ†°È™åÁ†Å‰ª• `.sha256` ÁªìÂ∞æ„ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
                echo 'ÂØπ‰∫é `deb` Á≥ªÂàóÁöÑÊâìÂåÖÊñá‰ª∂ÔºåÂèØ‰ª•‰∏ãËΩΩ `changes` Êñá‰ª∂ÔºàËØ•Êñá‰ª∂ÊòØgpgÁ≠æÂêçÔºå‰ΩÜÈùûÂàÜÁ¶ªÂºèÔºâÔºåÁÑ∂ÂêéÊâßË°å `gpg --verify xxx.changes` Âç≥ÂèØÈ™åËØÅÁúü‰º™ÔºåÂêåÊó∂ÊâìÂºÄ `changes` Êñá‰ª∂‰æøÂèØÊü•ÁúãÂÖ∂‰ªñÊñá‰ª∂Ôºà‰æãÂ¶Ç: .debÔºâÁöÑ `sha256` ÁºñÁ†ÅÔºå‰ªéËÄåÂØπ‰ªñ‰ª¨ËøõË°åËÆ§ËØÅ„ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

              echo '#### Windows/MacOS‰∏ä' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
              echo 'Â§ßÈÉ®ÂàÜÊìç‰ΩúÁöÑÂéüÊù•ÂíåLinuxÊòØÁõ∏ÂêåÁöÑ„ÄÇ`GPG` ÊñπÈù¢ÁöÑÊìç‰ΩúÂèØ‰ª•ÂÄüÂä© `Kleopatra`„ÄÇ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

            echo '### ÁâàÊú¨ËØ¥Êòé [#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
            echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
            echo '${{ github.event.pull_request.body }}' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

          echo '## ÊúÄÂêé' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo 'ÊÑüË∞¢Â§ßÂÆ∂ÔºÅ' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo "$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S Asia/Shanghai")" >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          echo '' >> ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md

      - name: Create github release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: "üëç Êñ∞ÁâàÊú¨ ${{ steps.tag_version.outputs.tag }} ÂèëÂ∏ÉÂï¶ üöÄüöÄüöÄ"
          tag_name: "${{ steps.tag_version.outputs.tag }}"
          body_path: ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
          files: |
            ${{ github.workspace }}/release_${{ steps.tag_version.outputs.tag }}_info.md
            ${{ github.workspace }}/gpg_public_key.asc
            ${{ github.workspace }}/${{ secrets.GPG_KEY_ID }}.gpg.key.id
            ${{ github.workspace }}/${{ env.OUTPUT_UBUNTU_NAME }}
            ${{ github.workspace }}/${{ env.OUTPUT_REHL_NAME }}
          preserve_order: true
          fail_on_unmatched_files: true
          generate_release_notes: true
          make_latest: "legacy"

      - name: Output the URL of the new release
        run: echo "The release is available at ${{ steps.create_release.outputs.html_url }}"

    outputs:
      tag: "${{ steps.tag_version.outputs.tag }}"
      version: $(echo "${{ needs.create_release.outputs.tag }}" | sed 's/^v//')
      release: "${{ steps.create_release.outputs.url }}"
      upload_url: "${{ steps.create_release.outputs.upload_url }}"

  build_deb:
    runs-on: ubuntu-latest
    needs:
      - ready
      - create_release

    env:
      FILE_SECTION: ".section"
      FILE_PRIORITY: ".priority"
      FILE_ARCHITECTURE: ".architecture"
      FILE_DEPENDS: ".depends"
      FILE_DESCRIBE: ".describe"
      FILE_MAINTAINER: ".maintainer"
      FILE_BIN_PATH: ".bin-path"
      FILE_COMPAT: ".compat"
      FILE_RULES: ".rules"
      FILE_COPYRIGHT: ".copyright"
      FILE_BUILD_DEPENDS: ".build.depends"

      DESCRIBE_DEFAULT: "The author, like a wisp of cloud passing by, leaves not a single word, yet bestows boundless room for imagination upon the world."
      BIN_PATH_DEFAULT: "usr/local/bin"
      ARCHITECTURE_DEFAULT: "amd64"
      COMPAT_DEFAULT: "10"

    steps:
      - name: Turn on universe
        run: |
          if grep -rq "universe" /etc/apt/sources.list /etc/apt/sources.list.d/; then
              echo "'universe' repository is already enabled."
          else
              echo "'universe' repository is not enabled. Enabling it now..."

              # ÂêØÁî® universe Ê∫ê
              sudo add-apt-repository universe -y

              # Ê£ÄÊü•ÂëΩ‰ª§ÊòØÂê¶ÊàêÂäü
              if [ $? -eq 0 ]; then
                  echo "'universe' repository has been successfully enabled."
              else
                  echo "Failed to enable 'universe' repository. Exiting..."
                  exit 1
              fi
          fi

      - name: Set up dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential
          sudo apt install -y dpkg-dev
          sudo apt install -y devscripts
          sudo apt install -y debhelper
          sudo apt install -y fakeroot
          sudo apt install -y gnupg

      # ÈÖçÁΩÆ GPG ÁéØÂ¢É
      - name: Configure GPG
        run: |
          mkdir ~/.gnupg
          chmod 700 ~/.gnupg
          
          touch ~/.gnupg/gpg.conf
          touch ~/.gnupg/gpg-agent.conf
          
          chmod 600 ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          
          gpg-connect-agent reloadagent /bye

      - name: Import GPG private key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --yes --import
          gpg --list-keys

      - name: Gpg-agent run check
        run: |
          if pgrep -x "gpg-agent" > /dev/null; then
              echo "gpg-agent is already running."
          else
              echo "gpg-agent is not running. Starting it now..."
              gpg-agent --daemon --sh --use-standard-socket >> $GITHUB_ENV
              if pgrep -x "gpg-agent" > /dev/null; then
                  echo "gpg-agent has been successfully started."
              else
                  echo "Failed to start gpg-agent."
                  exit 1
              fi
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï‰ª•‰æøËÉΩÂ§üÂàõÂª∫Ê†áÁ≠æ
          token: ${{ secrets.GITHUB_TOKEN }} # ‰ΩøÁî®GITHUB_TOKENËøõË°åË∫´‰ªΩÈ™åËØÅ

      - name: Download ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.OUTPUT_UBUNTU_NAME }}
          path: ${{ github.workspace }}

      - name: Default file check
        run: |
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_SECTION }}" ]; then
            echo "misc" > ${{ github.workspace }}/${{ env.FILE_SECTION }}
          fi

          if [ ! -f "${{ github.workspace }}/${{ env.FILE_PRIORITY }}" ]; then
            echo "extra" > ${{ github.workspace }}/${{ env.FILE_PRIORITY }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_ARCHITECTURE }}" ]; then
            echo "${{ env.ARCHITECTURE_DEFAULT }}" > ${{ github.workspace }}/${{ env.FILE_ARCHITECTURE }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_MAINTAINER }}" ]; then
            git show -s --format='%an<%ae>' $(git rev-list --max-parents=0 HEAD) > ${{ github.workspace }}/${{ env.FILE_MAINTAINER }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_DESCRIBE }}" ]; then
            echo "${{ env.DESCRIBE_DEFAULT }}" > ${{ github.workspace }}/${{ env.FILE_DESCRIBE }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_BIN_PATH }}" ]; then
            echo "${{ env.BIN_PATH_DEFAULT }}" > ${{ github.workspace }}/${{ env.FILE_BIN_PATH }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_COMPAT }}" ]; then
            echo "${{ env.COMPAT_DEFAULT }}" > ${{ github.workspace }}/${{ env.FILE_COMPAT }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_RULES }}" ]; then
            echo '#!/usr/bin/make -f' > ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '%:' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo -e '\tdh $@' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo 'override_dh_auto_build:' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo -e '\t# skip' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo 'override_dh_auto_test:' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo -e '\t# skip' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo 'override_dh_usrlocal:' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo -e '\t# skip' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
            echo '' >> ${{ github.workspace }}/${{ env.FILE_RULES }}
          fi
          
          if [ ! -f "${{ github.workspace }}/${{ env.FILE_COPYRIGHT }}" ]; then
            echo "Error: ${{ env.FILE_COPYRIGHT }} not found!"
            exit 1
          fi

      - name: Package into .deb
        id: before-package

        run: |
          mkdir -p "${{ github.workspace }}/debian"
          mkdir -p "${{ github.workspace }}/bin"
          
          VERSION="$(echo "${{ needs.create_release.outputs.tag }}" | sed 's/^v//')"
          
          echo "Source: ${{ env.PACKAGE_NAME }}" > ${{ github.workspace }}/debian/control
          echo "Maintainer: $(cat ${{ github.workspace }}/${{ env.FILE_MAINTAINER }})" >> ${{ github.workspace }}/debian/control
          echo "Section: $(cat ${{ github.workspace }}/${{ env.FILE_SECTION }})" >> ${{ github.workspace }}/debian/control
          echo "Priority: $(cat ${{ github.workspace }}/${{ env.FILE_PRIORITY }})" >> ${{ github.workspace }}/debian/control
          echo "Standards-Version: 4.5.0" >> ${{ github.workspace }}/debian/control
          if [ -f "${{ github.workspace }}/${{ env.FILE_DEPENDS }}" ]; then
            echo "Build-Depends: $(cat ${{ github.workspace }}/${{ env.FILE_BUILD_DEPENDS }})" >> ${{ github.workspace }}/debian/control
          else
            echo "Build-Depends: debhelper (>= 12)" >> ${{ github.workspace }}/debian/control
          fi  
          
          echo "" >> ${{ github.workspace }}/debian/control
          
          echo "Package: ${{ env.PACKAGE_NAME }}" >> ${{ github.workspace }}/debian/control
          echo "Architecture: $(cat ${{ github.workspace }}/${{ env.FILE_ARCHITECTURE }})" >> ${{ github.workspace }}/debian/control
          if [ -f "${{ github.workspace }}/${{ env.FILE_DEPENDS }}" ]; then
            echo "Depends: $(cat ${{ github.workspace }}/${{ env.FILE_DEPENDS }})" >> ${{ github.workspace }}/debian/control
          fi        
          echo "Description: $(cat ${{ github.workspace }}/${{ env.FILE_DESCRIBE }})" >> ${{ github.workspace }}/debian/control
          echo "Package: VERSION" >> ${{ github.workspace }}/debian/control
          
          cat ${{ github.workspace }}/debian/control
          
          cp ${{ github.workspace }}/${{ env.FILE_COMPAT }} ${{ github.workspace }}/debian/compat
          cp ${{ github.workspace }}/${{ env.FILE_COPYRIGHT }} ${{ github.workspace }}/debian/copyright
          cp ${{ github.workspace }}/${{ env.FILE_RULES }} ${{ github.workspace }}/debian/rules
          sudo chmod a+x ${{ github.workspace }}/debian/rules
          
          if [ ! -f "${{ github.workspace }}/debian/changelog" ]; then
            EDITOR="/bin/true" VISUAL="/bin/true" DEBFULLNAME="$(git show -s --format='%an' $(git rev-list --max-parents=0 HEAD))" DEBEMAIL="$(git show -s --format='%ae' $(git rev-list --max-parents=0 HEAD))" dch --create --package ${{ env.PACKAGE_NAME }} --newversion 1.0.0 --force-distribution --distribution unstable "Initial release"
          fi 
          
          sudo chmod a+x "${{ github.workspace }}/${{ env.OUTPUT_UBUNTU_NAME }}"
          mv "${{ github.workspace }}/${{ env.OUTPUT_UBUNTU_NAME }}" "${{ github.workspace }}/bin/${{ env.PACKAGE_NAME }}"
          
          echo "bin/${{ env.PACKAGE_NAME }} $(cat ${{ env.FILE_BIN_PATH }})" > ${{ github.workspace }}/debian/${{ env.PACKAGE_NAME }}.install
          
          EDITOR="/bin/true" VISUAL="/bin/true" DEBFULLNAME="$(git show -s --format='%an' $(git rev-list --max-parents=0 HEAD))" DEBEMAIL="$(git show -s --format='%ae' $(git rev-list --max-parents=0 HEAD))" dch --package ${{ env.PACKAGE_NAME }} --newversion ${VERSION} --force-distribution --distribution unstable "Visit to ${{ needs.create_release.outputs.release }}!"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "architecture=$(cat ${{ github.workspace }}/${{ env.FILE_ARCHITECTURE }})" >> $GITHUB_OUTPUT
          echo "maintainer=$(cat ${{ github.workspace }}/${{ env.FILE_MAINTAINER }})" >> $GITHUB_OUTPUT
          echo "describe=$(cat ${{ github.workspace }}/${{ env.FILE_DESCRIBE }})" >> $GITHUB_OUTPUT

      - name: List directory
        run: |
          echo "List ${{ github.workspace }}"
          ls -al ${{ github.workspace }}
          
          echo "List ${{ github.workspace }}/debian"
          ls -al ${{ github.workspace }}/debian

      - name: Package deb
        id: package
        run: |
          cat ${{ github.workspace }}/debian/rules
          DEB_BUILD_OPTIONS="parallel=4 nocheck" dpkg-buildpackage -k"${{ secrets.GPG_KEY_ID }}"

      - name: Sign package
        run: |
          cd ${{ github.workspace }}/..
          gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign ./${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.deb
          cd -

      - name: List directory after package
        run: ls -al ${{ github.workspace }}/../

      - name: Temporary copy file
        run: |
          mkdir -p ${{ github.workspace }}/temp
          
          cp ${{ github.workspace }}/../${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}.dsc ${{ github.workspace }}/temp
          cp ${{ github.workspace }}/../${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.deb ${{ github.workspace }}/temp
          cp ${{ github.workspace }}/../${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.deb.sig ${{ github.workspace }}/temp
          cp ${{ github.workspace }}/../${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.buildinfo ${{ github.workspace }}/temp
          cp ${{ github.workspace }}/../${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.changes ${{ github.workspace }}/temp

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_FILE_NAME_DEB }}
          path: |
            ${{ github.workspace }}/temp/${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}.dsc
            ${{ github.workspace }}/temp/${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.deb
            ${{ github.workspace }}/temp/${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.deb.sig
            ${{ github.workspace }}/temp/${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.buildinfo
            ${{ github.workspace }}/temp/${{ env.PACKAGE_NAME }}_${{ steps.before-package.outputs.version }}_${{ steps.before-package.outputs.architecture }}.changes
          if-no-files-found: error
          retention-days: 90

      - name: Create and use a temporary directory
        id: create_temp
        run: |
          echo "temp=$(mktemp -d)" >> $GITHUB_OUTPUT

      - name: Save changelog
        run: cp ${{ github.workspace }}/debian/changelog ${{ steps.create_temp.outputs.temp }}/changelog

      - name: Git set config
        run: |
          git config --global user.name $(git show -s --format='%an' $(git rev-list --max-parents=0 HEAD))
          git config --global user.email $(git show -s --format='%ae' $(git rev-list --max-parents=0 HEAD))
          git config --global pull.rebase true

      - name: Git reset
        run: git reset --hard HEAD

      - name: Git checkout branch
        run: |
          # Ê£ÄÊü•ËøúÁ®ãÊòØÂê¶ÊúâËØ•ÂàÜÊîØ
          if git ls-remote --heads origin ${{ env.CHANGE_LOG_DEB_BRANCH }}-deb | grep -q ${{ env.CHANGE_LOG_DEB_BRANCH }}; then
            git pull origin ${{ env.CHANGE_LOG_DEB_BRANCH }}:${{ env.CHANGE_LOG_DEB_BRANCH }}
            git checkout ${{ env.CHANGE_LOG_DEB_BRANCH }}
          else
            git pull origin ${{ needs.ready.outputs.branch }}:${{ needs.ready.outputs.branch }}
            git checkout ${{ needs.ready.outputs.branch }}
            git checkout -b ${{ env.CHANGE_LOG_DEB_BRANCH }}
          fi

      - name: Write changelog to git
        run: cp -f ${{ steps.create_temp.outputs.temp }}/changelog ${{ github.workspace }}/debian/changelog

      - name: Push debian/changelog
        run: |
          git add ${{ github.workspace }}/debian/changelog
          EDITOR="/bin/true" VISUAL="/bin/true" git commit -m "Update debian/changelog for ${{needs.create_release.outputs.tag}}"
          git push -f origin HEAD:${{ env.CHANGE_LOG_DEB_BRANCH }}

      - name: Create or get pull request
        id: create_pr
        run: |
          if [[ -z $(gh pr list --state open --head ${{ env.CHANGE_LOG_DEB_BRANCH }} --base ${{ needs.ready.outputs.branch }}) ]]; then
            gh pr create --title "Update debian/changelog" --body "This is an automated PR requesting a merge into debian/changelog. Created by github workflow." --base ${{ needs.ready.outputs.branch }} --head ${{ env.CHANGE_LOG_DEB_BRANCH }}
            echo "merge=true" >> $GITHUB_OUTPUT
            echo "New pull request"
          else
            echo "merge=false" >> $GITHUB_OUTPUT
            echo "Pull request exists"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Get pull request id
        id: get_prid
        if: steps.create_pr.outputs.merge == 'true'
        run: |
          PR_ID=$(gh pr list --state open --head ${{ env.CHANGE_LOG_DEB_BRANCH }} --base ${{ needs.ready.outputs.branch }} --json number --jq '.[0].number')
          if [ -z "$PR_ID" ]; then
            echo "PANIC Pull Requests Not Found"
            exit 1
          fi
          echo "prid=$PR_ID" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ github.token }}
      
      - name: Merge pull request
        if: steps.create_pr.outputs.merge == 'true'
        run:
          gh pr merge ${{steps.get_prid.outputs.prid}} --rebase --delete-branch
        env:
          GITHUB_TOKEN: ${{ github.token }}

    outputs:
      architecture: ${{ steps.before-package.outputs.architecture }}
      maintainer: ${{ steps.before-package.outputs.maintainer }}
      describe: ${{ steps.before-package.outputs.describe }}

  upload_package_deb:
    runs-on: ubuntu-latest
    needs:
      - create_release
      - build_deb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download package dev artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PACKAGE_FILE_NAME_DEB }}
          path: ${{ github.workspace }}

      - name: Get file sha256
        run: |
          echo "$(sha256sum ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.deb | awk '{print $1}')" > ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.create_release.outputs.architecture }}.deb.sha256

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create_release.outputs.tag }}
          files: |
            ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.deb
            ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.changes
            ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.deb.sig
            ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.deb.sha256
          preserve_order: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Ëá™Âä®Êèê‰æõÁöÑ GitHub Token

  publish_package_deb:
    runs-on: ubuntu-latest
    needs:
      - create_release
      - build_deb
      - upload_package_deb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.OUTPUT_UBUNTU_NAME }}
          path: ${{ github.workspace }}

      - name: Login to GitHub Packages
        run: |
          echo "${{ secrets.PACKAGE_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ‰∏ä‰º† .deb ÂåÖÂà∞ GitHub Packages
      - name: Upload Debian package to GitHub Packages
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.PACKAGE_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"package_type":"debian","name":"${{ env.PACKAGE_NAME }}","version":"${{ needs.create_release.outputs.version }}"}' \
            https://api.github.com/user/packages
      
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.PACKAGE_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ needs.create_release.outputs.version }}_${{ needs.build_deb.outputs.architecture }}.deb \
            https://api.github.com/user/packages/debian/${{ env.PACKAGE_NAME }}/versions/${{ needs.create_release.outputs.version }}/files/${{ env.PACKAGE_NAME }}.deb
